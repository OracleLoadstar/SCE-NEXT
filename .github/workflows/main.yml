name: æ„å»ºå¹¶å‘å¸ƒ WinUI åº”ç”¨ (ä½¿ç”¨ VsMSBuildCmd.bat)

on:
  push:
    branches:
      - main
  create:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      - name: ğŸ› ï¸ é€šè¿‡ Chocolatey å®‰è£… Visual Studio Build Tools åŠæ‰€éœ€ç»„ä»¶
        run: |
          Write-Host "â„¹ï¸ æ£€æŸ¥ Chocolatey æ˜¯å¦å·²å®‰è£…..."
          choco -?
          Write-Host "âœ… Chocolatey å·²å¯ç”¨ã€‚"

          $vsInstallerArguments = @(
              "--installPath", "D:\VSBuildTools",
              "--add", "Microsoft.VisualStudio.Workload.UniversalPlatform",
              "--add", "Microsoft.VisualStudio.Workload.VCTools",
              "--add", "Microsoft.VisualStudio.Component.Windows10SDK.26100",
              "--add", "Microsoft.VisualStudio.Component.VC.Redist.14.Latest",
              "--add", "Microsoft.VisualStudio.Component.Roslyn.Compiler",
              "--add", "Microsoft.Net.Component.DotNetBuildTools.6.0",
              "--add", "Microsoft.Net.Component.4.7.2.TargetingPack",
              "--add", "Microsoft.VisualStudio.Component.DesktopBridge",
              "--includeRecommended",
              "--quiet",     # é™é»˜å®‰è£…
              "--norestart"  # ç¦æ­¢å®‰è£…åé‡å¯
          ) -join ' '

          Write-Host "â„¹ï¸ ä¼ é€’ç»™ Chocolatey çš„åŸå§‹ VS å®‰è£…å‚æ•°å­—ç¬¦ä¸²: '$vsInstallerArguments'"

          choco install visualstudio2022buildtools --params "'$vsInstallerArguments'" --yes --force --timeout-minutes=50

          Write-Host "âœ… Chocolatey å®‰è£… Visual Studio Build Tools å®Œæˆã€‚"
        shell: pwsh
        timeout-minutes: 60 

      - name: ğŸ” éªŒè¯ Visual Studio å®‰è£…å¹¶è®¾ç½® MSBuild ç¯å¢ƒå˜é‡
        id: setup_msbuild_env
        run: |
          $vsPath = "D:\VSBuildTools" 
          
          if (-not (Test-Path $vsPath)) {
              Write-Error "âŒ é”™è¯¯: Visual Studio Build Tools 2022 æœªå®‰è£…åœ¨é¢„æœŸçš„è·¯å¾„: $vsPath"
              Write-Host "è¯·æ£€æŸ¥ Chocolatey å®‰è£…æ—¥å¿—ï¼Œç¡®è®¤å®‰è£…æ˜¯å¦æˆåŠŸä»¥åŠå®é™…å®‰è£…ä½ç½®ã€‚"
              exit 1
          }
          
          Write-Host "âœ… æ­¥éª¤: Visual Studio Build Tools 2022 å®‰è£…è·¯å¾„: $vsPath"

          # è™½ç„¶ä¸å†ç›´æ¥è°ƒç”¨ msbuild.exeï¼Œä½†ä¿ç•™å…¶è·¯å¾„ä»¥å¤‡è°ƒè¯•æˆ–å›é€€
          $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"
          if (-not (Test-Path $msbuildPath)) {
              $msbuildPath = Join-Path $vsPath "MSBuild\17.0\Bin\MSBuild.exe" 
          }
          
          Write-Host "âœ… æ­¥éª¤: æŸ¥æ‰¾ MSBuild.exe (å¤‡ç”¨)..."
          if (-not (Test-Path $msbuildPath)) {
              Write-Warning "âš ï¸ è­¦å‘Š: æœªèƒ½æ‰¾åˆ° MSBuild.exeï¼Œä½†è¿™å¯èƒ½ä¸å½±å“ VsMSBuildCmd.bat çš„ä½¿ç”¨ã€‚"
          }
          echo "msbuild_path=$msbuildPath" >> $env:GITHUB_OUTPUT # ä¾ç„¶å¯¼å‡º

          # â­ æ ¸å¿ƒä¿®æ”¹ï¼šæŸ¥æ‰¾ VsMSBuildCmd.bat
          $vsMSBuildCmdPath = Join-Path $vsPath "Common7\Tools\VsMSBuildCmd.bat"
          
          Write-Host "âœ… æ­¥éª¤: æŸ¥æ‰¾ VsMSBuildCmd.bat..."
          if (-not (Test-Path $vsMSBuildCmdPath)) {
              Write-Error "âŒ é”™è¯¯: æœªèƒ½æ‰¾åˆ° VsMSBuildCmd.batã€‚æ— æ³•æ­£ç¡®é…ç½® Visual Studio æ„å»ºç¯å¢ƒå¹¶æ‰§è¡Œ MSBuildã€‚"
              exit 1
          }
          echo "vs_msbuild_cmd_path=$vsMSBuildCmdPath" >> $env:GITHUB_OUTPUT # å¯¼å‡º VsMSBuildCmd.bat è·¯å¾„
          
          # è¿™äº› PATH è®¾ç½®ç°åœ¨å¯èƒ½ä¸å†ä¸¥æ ¼å¿…è¦ï¼Œä½†ä¿ç•™æ— å®³
          echo "##vso[task.prependpath]$($msbuildPath | Split-Path -Parent)"
          echo "VSCMD_START_DIR=$vsPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          Write-Host "âœ… æ­¥éª¤: MSBuild (å¤‡ç”¨) å·²æ·»åŠ åˆ° PATH: $($msbuildPath | Split-Path -Parent)"
          Write-Host "âœ… æ­¥éª¤: VSCMD_START_DIR å·²è®¾ç½®: $vsPath"
          Write-Host "âœ… æ­¥éª¤: VsMSBuildCmd.bat è·¯å¾„å·²ä½œä¸ºè¾“å‡ºå˜é‡ 'vs_msbuild_cmd_path' å¯¼å‡ºã€‚"
        shell: pwsh

      - name: ğŸ§¹ æ¸…ç† NuGet å…¨å±€ç¼“å­˜ (å¯é€‰)
        run: dotnet nuget locals all --clear
        shell: pwsh

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ– (ä½¿ç”¨ VsMSBuildCmd.bat)
        run: |
          $repoPath = "${{ github.workspace }}"
          Set-Location -Path $repoPath
          Write-Host "âœ… å·²å°†å·¥ä½œç›®å½•æ›´æ”¹ä¸º: $(Get-Location)"
          
          Write-Host "ğŸ” éªŒè¯ App2.sln åœ¨å½“å‰ç›®å½•çš„å­˜åœ¨..."
          Get-ChildItem -Path . | Format-Table -AutoSize
          if (-not (Test-Path "App2.sln")) {
              Write-Error "âŒ é”™è¯¯: App2.sln æœªåœ¨å½“å‰ç›®å½•æ‰¾åˆ°ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚"
              exit 1
          }
          Write-Host "âœ… App2.sln å·²ç¡®è®¤å­˜åœ¨äºå½“å‰ç›®å½•ã€‚"

          # â­ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥è°ƒç”¨ VsMSBuildCmd.bat å¹¶ä¼ é€’å‚æ•°
          # æ³¨æ„ï¼šVsMSBuildCmd.bat é»˜è®¤ä¼šå¯åŠ¨ä¸€ä¸ª CMD ä¼šè¯ï¼Œå¹¶ç›´æ¥æ‰§è¡Œåé¢çš„å‚æ•°ä½œä¸º MSBuild çš„å‚æ•°
          # è¿™æ ·å¯ä»¥é¿å…ä¹‹å‰å¤æ‚çš„å¼•å·é—®é¢˜ã€‚
          # ä¼ é€’ /clp:ErrorsOnly å‚æ•°ï¼Œåªæ˜¾ç¤ºé”™è¯¯å’Œæ€»ç»“ï¼Œå‡å°‘æ—¥å¿—å†—ä½™ã€‚
          $command = "`"${{ steps.setup_msbuild_env.outputs.vs_msbuild_cmd_path }}`" App2.sln /t:restore /clp:ErrorsOnly"
          Write-Host "â„¹ï¸ æ­£åœ¨æ‰§è¡Œå‘½ä»¤: $command"
          
          Start-Process -FilePath "cmd.exe" -ArgumentList "/c", $command -NoNewWindow -Wait -ErrorAction Stop
          Write-Host "âœ… MSBuild æ¢å¤é¡¹ç›®ä¾èµ–å®Œæˆã€‚"
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX (ä½¿ç”¨ VsMSBuildCmd.bat)
        run: |
          $repoPath = "${{ github.workspace }}"
          Set-Location -Path $repoPath
          Write-Host "âœ… å·²å°†å·¥ä½œç›®å½•æ›´æ”¹ä¸º: $(Get-Location)"

          Write-Host "ğŸ” éªŒè¯ App2.sln åœ¨å½“å‰ç›®å½•çš„å­˜åœ¨..."
          Get-ChildItem -Path . | Format-Table -AutoSize
          if (-not (Test-Path "App2.sln")) {
              Write-Error "âŒ é”™è¯¯: App2.sln æœªåœ¨å½“å‰ç›®å½•æ‰¾åˆ°ã€‚è¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨æˆ–è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚"
              exit 1
          }
          Write-Host "âœ… App2.sln å·²ç¡®è®¤å­˜åœ¨äºå½“å‰ç›®å½•ã€‚"

          # â­ æ ¸å¿ƒä¿®æ”¹ï¼šç›´æ¥è°ƒç”¨ VsMSBuildCmd.bat å¹¶ä¼ é€’å‚æ•°
          $command = "`"${{ steps.setup_msbuild_env.outputs.vs_msbuild_cmd_path }}`" App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload /clp:ErrorsOnly"
          Write-Host "â„¹ï¸ æ­£åœ¨æ‰§è¡Œå‘½ä»¤: $command"

          Start-Process -FilePath "cmd.exe" -ArgumentList "/c", $command -NoNewWindow -Wait -ErrorAction Stop
          Write-Host "âœ… MSBuild ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨å®Œæˆã€‚"
        shell: pwsh 

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          $repoPath = "${{ github.workspace }}"
          Set-Location -Path $repoPath
          Write-Host "âœ… å·²å°†å·¥ä½œç›®å½•æ›´æ”¹ä¸º: $(Get-Location)"

          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ MSBuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix
          asset_content_type: application/msix
