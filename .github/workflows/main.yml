name: æ„å»ºå¹¶å‘å¸ƒ WinUI åº”ç”¨ (é€šè¿‡ Chocolatey å®‰è£… VS Build Tools)

on:
  push:
    branches:
      - main
  create:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      - name: ğŸ› ï¸ é€šè¿‡ Chocolatey å®‰è£… Visual Studio Build Tools åŠæ‰€éœ€ç»„ä»¶
        # â­ æ ¸å¿ƒä¿®æ”¹ï¼šä½¿ç”¨ choco install å‘½ä»¤
        # --package-parameters å¯ä»¥ä¼ é€’ç»™ Chocolatey åŒ…å†…éƒ¨çš„å®‰è£…è„šæœ¬
        # è¿™é‡Œæˆ‘ä»¬å°†æ‰€æœ‰çš„ VS ç»„ä»¶å‚æ•°æ‰“åŒ…æˆå­—ç¬¦ä¸²ï¼Œä¼ é€’ç»™ Chocolatey çš„ VS å®‰è£…åŠ©æ‰‹
        run: |
          Write-Host "â„¹ï¸ æ£€æŸ¥ Chocolatey æ˜¯å¦å·²å®‰è£…..."
          choco -?
          Write-Host "âœ… Chocolatey å·²å¯ç”¨ã€‚"

          $vsInstallPath = "D:\VSBuildTools"
          $vsComponents = @(
              "--installPath", $vsInstallPath,
              "--add", "Microsoft.VisualStudio.Workload.VCTools",
              "--add", "Microsoft.VisualStudio.Workload.UniversalBuildTools",
              "--add", "Microsoft.VisualStudio.Component.WindowsAppSDK",
              "--add", "Microsoft.Net.Component.4.7.2.TargetingPack",
              "--add", "Microsoft.VisualStudio.Component.Windows10SDK.26100",
              "--add", "Microsoft.VisualStudio.Component.VC.Redist.14.Latest",
              "--add", "Microsoft.VisualStudio.Component.Roslyn.Compiler",
              "--add", "Microsoft.VisualStudio.Component.DotNetBuildTools.6.0",
              "--includeRecommended" # Chocolatey åŒ…é€šå¸¸ä¼šå¤„ç† --wait å’Œ --quiet
          )

          $packageParameters = ($vsComponents | ConvertTo-Json -Compress) -replace "`"","`"" # å°†æ•°ç»„è½¬æ¢ä¸ºJSONå­—ç¬¦ä¸²ï¼Œå¹¶è½¬ä¹‰åŒå¼•å·
          $packageParameters = $packageParameters.Trim("[]") # ç§»é™¤ JSON æ•°ç»„çš„æ–¹æ‹¬å·

          Write-Host "â„¹ï¸ ä¼ é€’ç»™ Chocolatey çš„ VS ç»„ä»¶å‚æ•°: $($packageParameters)"

          # å¼ºåˆ¶å®‰è£…ï¼Œå¹¶ä¼ é€’æ‰€æœ‰ VS å®‰è£…å‚æ•°
          # /InstallArguments ä¼šå°†å‚æ•°ä¼ é€’ç»™ vs_buildtools.exe
          # /PackageParameters ä¼šå°†å‚æ•°ä¼ é€’ç»™ Chocolatey åŒ…çš„å®‰è£…è„šæœ¬ï¼Œç”±å®ƒæ¥æ„å»º vs_buildtools.exe çš„å‚æ•°
          # æˆ‘ä»¬éœ€è¦çš„æ˜¯ /PackageParameters
          choco install visualstudio2022buildtools `
            --version 17.0.0.0 ` # æ˜ç¡®æŒ‡å®šç‰ˆæœ¬ï¼Œé¿å…ä¸å¯é¢„æµ‹çš„æœ€æ–°ç‰ˆé—®é¢˜
            --params "'$packageParameters'" ` # ç¡®ä¿å‚æ•°è¢«æ­£ç¡®ä¼ é€’ï¼Œè¿™é‡Œéœ€è¦å•å¼•å·åŒ…å›´
            --yes ` # è‡ªåŠ¨åŒæ„æ‰€æœ‰æç¤º
            --force ` # å¼ºåˆ¶å®‰è£…/é‡æ–°å®‰è£…
            --timeout-minutes=35 # è®¾ç½®è¶…æ—¶æ—¶é—´

          Write-Host "âœ… Chocolatey å®‰è£… Visual Studio Build Tools å®Œæˆã€‚"
        shell: pwsh
        timeout-minutes: 40 # ç»™äºˆ Chocolatey å……è¶³çš„ä¸‹è½½å’Œå®‰è£…æ—¶é—´

      - name: ğŸ” éªŒè¯ Visual Studio å®‰è£…å¹¶è®¾ç½® MSBuild ç¯å¢ƒå˜é‡
        id: setup_msbuild_env
        run: |
          $vsPath = "D:\VSBuildTools" # Chocolatey é»˜è®¤å®‰è£…åˆ° Program Filesï¼Œä½†æˆ‘ä»¬å°è¯•æŒ‡å®š D:\VSBuildTools
                                      # Chocolatey çš„ VS åŒ…é€šå¸¸ä¼šå¿½ç•¥ --installPath å¹¶å®‰è£…åˆ°é»˜è®¤ä½ç½®
                                      # æ‰€ä»¥æˆ‘ä»¬å¯èƒ½éœ€è¦æ ¹æ®å®é™…å®‰è£…è·¯å¾„è°ƒæ•´
          
          # æ£€æŸ¥ Chocolatey å®é™…å®‰è£… VS Build Tools çš„è·¯å¾„
          # é€šå¸¸åœ¨ C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools
          $actualVsPath = (Get-ChildItem -Path "C:\Program Files (x86)\Microsoft Visual Studio\*" -Directory | Where-Object { $_.Name -like "*2022*" -and $_.Name -like "*BuildTools*" } | Select-Object -ExpandProperty FullName -First 1)

          if (-not $actualVsPath) {
             $actualVsPath = (Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\*" -Directory | Where-Object { $_.Name -like "*2022*" -and $_.Name -like "*BuildTools*" } | Select-Object -ExpandProperty FullName -First 1)
          }

          if (-not $actualVsPath) {
              Write-Error "âŒ é”™è¯¯: æœªèƒ½åœ¨é»˜è®¤ä½ç½®æ‰¾åˆ° Visual Studio Build Tools 2022 çš„å®‰è£…è·¯å¾„ã€‚è¯·æ£€æŸ¥ Chocolatey å®‰è£…æ—¥å¿—ã€‚"
              Write-Host "--- C:\Program Files (x86)\Microsoft Visual Studio\ ç›®å½•å†…å®¹ ---"
              Get-ChildItem -Path "C:\Program Files (x86)\Microsoft Visual Studio\" -ErrorAction SilentlyContinue | Format-Table -AutoSize
              Write-Host "--- C:\Program Files\Microsoft Visual Studio\ ç›®å½•å†…å®¹ ---"
              Get-ChildItem -Path "C:\Program Files\Microsoft Visual Studio\" -ErrorAction SilentlyContinue | Format-Table -AutoSize
              exit 1
          }
          
          Write-Host "âœ… æ­¥éª¤: Visual Studio Build Tools 2022 å®‰è£…è·¯å¾„: $actualVsPath"
          $vsPath = $actualVsPath # ä½¿ç”¨å®é™…æ‰¾åˆ°çš„è·¯å¾„

          $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"
          if (-not (Test-Path $msbuildPath)) {
              $msbuildPath = Join-Path $vsPath "MSBuild\17.0\Bin\MSBuild.exe" 
          }
          
          Write-Host "âœ… æ­¥éª¤: æŸ¥æ‰¾ MSBuild.exe..."
          if (-not (Test-Path $msbuildPath)) {
              Write-Error "âŒ é”™è¯¯: æœªèƒ½æ‰¾åˆ°æ–°å®‰è£…çš„ MSBuild.exeã€‚è¯·æ£€æŸ¥å®‰è£…è·¯å¾„å’Œç»“æ„ã€‚"
              Write-Host "--- $vsPath ç›®å½•å†…å®¹ ---"
              Get-ChildItem -Path $vsPath -Recurse -ErrorAction SilentlyContinue | Format-Table -AutoSize
              Write-Host "--- $vsPath ç›®å½•å†…å®¹ç»“æŸ ---"
              exit 1
          }
          
          echo "##vso[task.prependpath]$($msbuildPath | Split-Path -Parent)"
          echo "VSCMD_START_DIR=$vsPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          Write-Host "âœ… æ­¥éª¤: MSBuild å·²æ·»åŠ åˆ° PATH: $($msbuildPath | Split-Path -Parent)"
        shell: pwsh

      - name: ğŸ§¹ æ¸…ç† NuGet å…¨å±€ç¼“å­˜ (å¯é€‰)
        run: dotnet nuget locals all --clear
        shell: pwsh

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ– (ä½¿ç”¨ MSBuild)
        run: msbuild App2.sln /t:restore
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX
        run: |
          msbuild App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload
        shell: pwsh 

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ MSBuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix
          asset_content_type: application/msix
