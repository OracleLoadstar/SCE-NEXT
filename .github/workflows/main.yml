name: Build and Release WinUI App (Exact SDK Match & Clean Cache)

on:
  push:
    branches:
      - main
  create: # æ ‡ç­¾åˆ›å»ºæ—¶è§¦å‘ï¼ˆç”¨äºå‘å¸ƒ Releaseï¼‰
    tags:
      - 'v*' # åŒ¹é…ä¾‹å¦‚ v1.0.0, v1.0 ç­‰æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: windows-latest # WinUI é¡¹ç›®éœ€è¦ Windows è¿è¡Œå™¨

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK (C++é¡¹ç›®å¯èƒ½ä¸ç›´æ¥ä¾èµ–ï¼Œä½†ä¸ºå…¼å®¹æ€§ä¿ç•™)
        uses: actions/setup-dotnet@v4
        with:
          # æ‚¨çš„é¡¹ç›®æ˜¯C++ WinUIï¼Œ.NET SDKç‰ˆæœ¬å¯èƒ½ä¸ç›´æ¥å½±å“ï¼Œä½†ä¸ºç¡®ä¿æ‰€æœ‰å·¥å…·é“¾å…¼å®¹æ€§ï¼Œ
          # å»ºè®®ä¸æ‚¨æœ¬åœ°å¼€å‘ç¯å¢ƒçš„.NETç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œæˆ–ä½¿ç”¨ä¸€ä¸ªå¸¸ç”¨ç‰ˆæœ¬å¦‚6.0.x
          dotnet-version: '6.0.x' 

      - name: ğŸ› ï¸ å®‰è£… Visual Studio MSBuild åŠç²¾ç¡®åŒ¹é…çš„WinUI/C++ç»„ä»¶å’ŒSDK
        # æ­¤æ­¥éª¤ä½¿ç”¨ microsoft/setup-msbuild Actionï¼Œå¹¶æ ¹æ®æ‚¨çš„é¡¹ç›®æ–‡ä»¶ï¼ˆ.vcxprojå’Œ.wapprojï¼‰
        # ç²¾ç¡®æŒ‡å®šæ‰€éœ€çš„Windows SDKç‰ˆæœ¬å’Œæ‰€æœ‰å¿…è¦çš„æ„å»ºç»„ä»¶ã€‚
        uses: microsoft/setup-msbuild@v1.1
        with:
          msbuild-version: latest # å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ MSBuild
          # æ˜ç¡®åˆ—å‡ºåŒ¹é…ä½ æœ¬åœ°VSå®‰è£…å’ŒSLNæ–‡ä»¶åˆ†æçš„ç»„ä»¶ID
          components: |
            Microsoft.VisualStudio.Component.MSBuild # MSBuildæ ¸å¿ƒ
            Microsoft.VisualStudio.Component.Roslyn.Compiler # C# å’Œ VB ç¼–è¯‘å™¨ (é€šå¸¸éœ€è¦)
            
            # C++ æ¡Œé¢å¼€å‘å·¥ä½œè´Ÿè½½æ ¸å¿ƒç»„ä»¶ (æ ¹æ®SLNä¸­çš„ .vcxproj ç¡®è®¤éœ€è¦)
            Microsoft.VisualStudio.Component.VC.Tools.x86.x64 # C++ æ„å»ºå·¥å…· (v143)
            Microsoft.VisualStudio.Component.VC.Redist.14.Latest # é‡è¦çš„ C++ å¯å†å‘è¡Œç»„ä»¶ï¼Œè§£å†³DLLä¾èµ–
            Microsoft.VisualStudio.Component.Desktop.SDK.Editor # æ¡Œé¢å¼€å‘ç›¸å…³çš„SDKå’Œç¼–è¾‘å™¨å·¥å…·
            
            # Windows åº”ç”¨å¼€å‘å·¥ä½œè´Ÿè½½æ ¸å¿ƒç»„ä»¶ (æ ¹æ® SLN ä¸­çš„ .wapproj ç¡®è®¤éœ€è¦)
            Microsoft.VisualStudio.Component.UWP.BuildTools # UWP æ„å»ºå·¥å…·
            Microsoft.VisualStudio.Component.WindowsAppSDK # Windows App SDK å¼€å‘ç»„ä»¶
            # å…³é”®ï¼è§£å†³ XAML Compiler.dll å¯¹ .NET Framework 4.7.2 çš„ä¾èµ–
            Microsoft.Net.Component.4.7.2.TargetingPack 
            
            # â­ ç²¾ç¡®æŒ‡å®šé¡¹ç›®ä¾èµ–çš„ Windows SDK ç‰ˆæœ¬
            # æ ¹æ® App2 (Package).wapproj ä¸­çš„ <TargetPlatformVersion>10.0.26100.0</TargetPlatformVersion>
            # ä»¥åŠ App2.vcxproj ä¸­å¼•ç”¨çš„ SDK Build Tools 10.0.26100.4188
            # è¿™ä¸ªç»„ä»¶IDé€šå¸¸æ˜¯ Microsoft.VisualStudio.Component.Windows10SDK.ç‰ˆæœ¬å·
            Microsoft.VisualStudio.Component.Windows10SDK.26100 
            
            # .NET æ„å»ºå·¥å…· (ä¸ setup-dotnet ä¸­çš„ç‰ˆæœ¬ä¸€è‡´)
            Microsoft.VisualStudio.Component.DotNetBuildTools.6.0 # è°ƒæ•´ä¸ºä½ é¡¹ç›®ä½¿ç”¨çš„ .NET ç‰ˆæœ¬

      - name: ğŸ§¹ æ¸…ç† NuGet å…¨å±€ç¼“å­˜
        # åœ¨æ¢å¤ä¾èµ–ä¹‹å‰ï¼Œæ¸…ç†æœ¬åœ°çš„NuGetç¼“å­˜ï¼Œç¡®ä¿ä¸‹è½½æœ€æ–°çš„ã€æœªæŸåçš„åŒ…ã€‚
        run: dotnet nuget locals all --clear
        shell: pwsh

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ–
        # è¿è¡Œ dotnet restore æ¥ä¸‹è½½ NuGet åŒ…
        # è§£å†³æ–¹æ¡ˆæ–‡ä»¶åä¸º 'App2.sln'
        run: dotnet restore App2.sln 
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX
        # ä½¿ç”¨ MSBuild å‘½ä»¤ç¼–è¯‘è§£å†³æ–¹æ¡ˆå¹¶æ‰“åŒ…ä¸º MSIX
        # MSBuild æ­¤æ—¶åº”å·²æ­£ç¡®æ·»åŠ åˆ° PATH ä¸­
        # è§£å†³æ–¹æ¡ˆæ–‡ä»¶åä¸º 'App2.sln'
        run: |
          msbuild App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload
        shell: pwsh 

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          # åŠ¨æ€æŸ¥æ‰¾ç”Ÿæˆçš„ .msix æ–‡ä»¶ã€‚å¯¹äº WinUI é¡¹ç›®ï¼Œå¸¸è§è¾“å‡ºè·¯å¾„åœ¨ï¼š
          # .\App2 (Package)\AppPackages\App2 (Package)_...\*.msix
          # æˆ–è€… .\App2 (Package)\bin\Release\
          # æˆ‘ä»¬ä½¿ç”¨æ›´é€šç”¨çš„é€’å½’æœç´¢ï¼Œä¼˜å…ˆåŒ¹é… AppPackages ç›®å½•æˆ– bin\Release' ç›®å½•ä¸‹çš„ .msix æ–‡ä»¶
          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ MSBuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        # å°†æ‰¾åˆ°çš„ MSIX æ–‡ä»¶ä½œä¸º GitHub Actions çš„â€œå·¥ä½œæµäº§ç‰©â€ä¸Šä¼ ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä¸‹è½½ã€‚
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        # ä»…åœ¨é€šè¿‡æ ‡ç­¾è§¦å‘æ—¶è¿è¡Œã€‚æ­¤æ­¥éª¤ä¼šåœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ Releaseã€‚
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ä»¤ç‰Œ
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        # ä»…åœ¨é€šè¿‡æ ‡ç­¾è§¦å‘ä¸” MSIX æ–‡ä»¶æ‰¾åˆ°æ—¶è¿è¡Œã€‚å°† MSIX æ–‡ä»¶ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ° Releaseã€‚
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix # â­ æ ¹æ®éœ€è¦è°ƒæ•´èµ„äº§æ–‡ä»¶å
          asset_content_type: application/msix
