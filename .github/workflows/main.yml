name: æ„å»ºå¹¶å‘å¸ƒ WinUI åº”ç”¨ (ç»ˆæ VS Build Tools è°ƒè¯•)

on:
  push:
    branches:
      - main
  create:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' 

      - name: â¬‡ï¸ ä¸‹è½½ Visual Studio Build Tools å®‰è£…å™¨
        run: |
          Write-Host "âœ… æ­¥éª¤: å¼€å§‹ä¸‹è½½ vs_buildtools.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vs_buildtools.exe" -OutFile vs_buildtools.exe
          Write-Host "âœ… æ­¥éª¤: vs_buildtools.exe ä¸‹è½½å®Œæˆã€‚"
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "vs_buildtools.exe")) {
              Write-Error "âŒ é”™è¯¯: vs_buildtools.exe æ–‡ä»¶æœªæˆåŠŸä¸‹è½½ã€‚"
              exit 1
          }
        shell: pwsh

      - name: ğŸ› ï¸ å®‰è£… Visual Studio Build Tools åŠæ‰€éœ€ç»„ä»¶ (ç»ˆæè°ƒè¯•)
        run: |
          $logFile = "vs_install_output.log"
          $errorFile = "vs_install_error.log"

          Write-Host "âœ… æ­¥éª¤: å‡†å¤‡æ‰§è¡Œ vs_buildtools.exe å®‰è£…å‘½ä»¤ã€‚"
          Write-Host "â„¹ï¸ å®‰è£…å‘½ä»¤å‚æ•°ï¼š"
          $arguments = @(
              "--installPath", "D:\VSBuildTools",
              "--add", "Microsoft.VisualStudio.Workload.VCTools",
              "--add", "Microsoft.VisualStudio.Workload.UniversalBuildTools",
              "--add", "Microsoft.VisualStudio.Component.WindowsAppSDK",
              "--add", "Microsoft.Net.Component.4.7.2.TargetingPack",
              "--add", "Microsoft.VisualStudio.Component.Windows10SDK.26100",
              "--add", "Microsoft.VisualStudio.Component.VC.Redist.14.Latest",
              "--add", "Microsoft.VisualStudio.Component.Roslyn.Compiler",
              "--add", "Microsoft.VisualStudio.Component.DotNetBuildTools.6.0",
              "--includeRecommended",
              "--wait"
          )
          $arguments | ForEach-Object { Write-Host "  - $_" } # æ‰“å°æ‰€æœ‰å‚æ•°
          Write-Host "â„¹ï¸ å®‰è£…è¾“å‡ºå°†é‡å®šå‘åˆ°æ—¥å¿—æ–‡ä»¶ '$logFile' å’Œ '$errorFile'..."

          # æ‰§è¡Œå®‰è£…å™¨ï¼Œæ•è·å…¶è¾“å‡ºå’Œé”™è¯¯åˆ°æ–‡ä»¶ï¼Œå¹¶ç­‰å¾…å…¶å®Œæˆ
          $process = Start-Process -FilePath ".\vs_buildtools.exe" -ArgumentList $arguments -RedirectStandardOutput $logFile -RedirectStandardError $errorFile -NoNewWindow -Wait -PassThru
          
          Write-Host "âœ… æ­¥éª¤: vs_buildtools.exe è¿›ç¨‹å·²é€€å‡ºã€‚æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å†…å®¹ã€‚"

          Write-Host "--- Visual Studio å®‰è£…æ ‡å‡†è¾“å‡º ---"
          Get-Content $logFile -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_ }
          Write-Host "--- Visual Studio å®‰è£…æ ‡å‡†è¾“å‡ºç»“æŸ ---"

          Write-Host "--- Visual Studio å®‰è£…æ ‡å‡†é”™è¯¯ ---"
          Get-Content $errorFile -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_ }
          Write-Host "--- Visual Studio å®‰è£…æ ‡å‡†é”™è¯¯ç»“æŸ ---"
          
          # æ£€æŸ¥å®‰è£…å™¨è¿›ç¨‹çš„é€€å‡ºç 
          Write-Host "â„¹ï¸ Visual Studio Build Tools å®‰è£…å™¨é€€å‡ºç : $($process.ExitCode)"
          if ($process.ExitCode -ne 0) {
              Write-Error "âŒ é”™è¯¯: Visual Studio Build Tools å®‰è£…å™¨é€€å‡ºç éé›¶ã€‚å®‰è£…å¯èƒ½å¤±è´¥ã€‚"
              exit $process.ExitCode
          }
          Write-Host "âœ… æ­¥éª¤: Visual Studio Build Tools å®‰è£…å™¨è¿›ç¨‹æˆåŠŸé€€å‡º (é€€å‡ºç ä¸º0)ã€‚"

        shell: pwsh
        timeout-minutes: 35 # è¿›ä¸€æ­¥å»¶é•¿è¶…æ—¶æ—¶é—´ï¼Œä»¥é˜²ä¸‹è½½ç¼“æ…¢

      - name: ğŸ” éªŒè¯ Visual Studio å®‰è£…å¹¶è®¾ç½® MSBuild ç¯å¢ƒå˜é‡
        id: setup_msbuild_env
        run: |
          $vsPath = "D:\VSBuildTools"
          
          Write-Host "âœ… æ­¥éª¤: éªŒè¯ D:\VSBuildTools ç›®å½•æ˜¯å¦å­˜åœ¨..."
          if (-not (Test-Path -Path $vsPath -PathType Container)) {
              Write-Error "âŒ é”™è¯¯: VS Build Tools å®‰è£…è·¯å¾„ '$vsPath' ä¸å­˜åœ¨ã€‚å®‰è£…å¯èƒ½å¤±è´¥ã€‚"
              Write-Host "--- D:\ é©±åŠ¨å™¨å†…å®¹ ---"
              Get-ChildItem -Path "D:\" -Recurse -ErrorAction SilentlyContinue | Format-Table -AutoSize # æ£€æŸ¥ D ç›˜æ ¹ç›®å½•
              Write-Host "--- D:\ é©±åŠ¨å™¨å†…å®¹ç»“æŸ ---"
              exit 1
          }
          Write-Host "âœ… æ­¥éª¤: D:\VSBuildTools ç›®å½•å­˜åœ¨ã€‚"

          $msbuildPath = Join-Path $vsPath "MSBuild\Current\Bin\MSBuild.exe"
          if (-not (Test-Path $msbuildPath)) {
              $msbuildPath = Join-Path $vsPath "MSBuild\17.0\Bin\MSBuild.exe" 
          }
          
          Write-Host "âœ… æ­¥éª¤: æŸ¥æ‰¾ MSBuild.exe..."
          if (-not (Test-Path $msbuildPath)) {
              Write-Error "âŒ é”™è¯¯: æœªèƒ½æ‰¾åˆ°æ–°å®‰è£…çš„ MSBuild.exeã€‚è¯·æ£€æŸ¥å®‰è£…è·¯å¾„å’Œç»“æ„ã€‚"
              Write-Host "--- D:\VSBuildTools ç›®å½•å†…å®¹ ---"
              Get-ChildItem -Path "D:\VSBuildTools" -Recurse -ErrorAction SilentlyContinue | Format-Table -AutoSize
              Write-Host "--- D:\VSBuildTools ç›®å½•å†…å®¹ç»“æŸ ---"
              exit 1
          }
          
          echo "##vso[task.prependpath]$($msbuildPath | Split-Path -Parent)"
          echo "VSCMD_START_DIR=$vsPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          Write-Host "âœ… æ­¥éª¤: MSBuild å·²æ·»åŠ åˆ° PATH: $($msbuildPath | Split-Path -Parent)"
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  Visual Studio å®‰è£…æ—¥å¿— (å¦‚æœå®‰è£…å¤±è´¥)
        if: always() 
        uses: actions/upload-artifact@v4
        with:
          name: VS_Build_Tools_Install_Logs
          path: |
            C:\ProgramData\Microsoft\VisualStudio\Packages\_Instances\**\*.log
            vs_install_output.log 
            vs_install_error.log  
          retention-days: 5 

      - name: ğŸ§¹ æ¸…ç† NuGet å…¨å±€ç¼“å­˜ (å¯é€‰)
        run: dotnet nuget locals all --clear
        shell: pwsh

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ– (ä½¿ç”¨ MSBuild)
        run: msbuild App2.sln /t:restore
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX
        run: |
          msbuild App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload
        shell: pwsh 

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ MSBuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix
          asset_content_type: application/msix
