name: Build and Release WinUI App

on:
  push:
    branches:
      - main
  create: # å½“åˆ›å»ºæ ‡ç­¾æ—¶è§¦å‘ï¼ˆç”¨äºå‘å¸ƒ Releaseï¼‰
    tags:
      - 'v*' # åŒ¹é…ä¾‹å¦‚ v1.0.0, v1.0 ç­‰æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: windows-latest # WinUI é¡¹ç›®éœ€è¦ Windows è¿è¡Œå™¨

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          # â­ è¯·æ ¹æ®ä½ çš„ WinUI é¡¹ç›®çš„ .NET ç‰ˆæœ¬è°ƒæ•´ (ä¾‹å¦‚: 6.0.x, 7.0.x, 8.0.x)
          dotnet-version: '6.0.x' 

      - name: ğŸ› ï¸ å®‰è£… Visual Studio MSBuild å·¥å…·åŠWinUIç›¸å…³ç»„ä»¶
        # ä½¿ç”¨ microsoft/setup-msbuild Action ç¡®ä¿å®‰è£… MSBuild å’Œ WinUI æ„å»ºæ‰€éœ€çš„æ ¸å¿ƒç»„ä»¶ã€‚
        # é”™è¯¯ MSB4062 å¾€å¾€æ˜¯å› ä¸ºç¼ºå°‘äº†å¦‚ .NET Framework 4.7.2 Targeting Pack ç­‰ä¾èµ–ã€‚
        # æ­¤ Action ä¼šè‡ªåŠ¨å°† MSBuild æ·»åŠ åˆ° PATH ä¸­ã€‚
        uses: microsoft/setup-msbuild@v1.1
        with:
          msbuild-version: latest
          # æ˜ç¡®åˆ—å‡º WinUI æ„å»ºæ‰€éœ€çš„ç»„ä»¶
          # è¿™äº›æ˜¯åŸºäºå¸¸è§ WinUI é¡¹ç›®ä¾èµ–å’ŒMSB4062é”™è¯¯åˆ†ææ‰€é€‰
          components: |
            Microsoft.VisualStudio.Component.MSBuild
            Microsoft.VisualStudio.Component.Roslyn.Compiler
            Microsoft.VisualStudio.Component.VC.Tools.x86.x64
            # â­ æ ¹æ®ä½ çš„é¡¹ç›®ç›®æ ‡è°ƒæ•´ Windows SDK ç‰ˆæœ¬ï¼Œä¾‹å¦‚ 10.0.19041.0
            Microsoft.VisualStudio.Component.Windows10SDK.19041 
            # â­ æ ¹æ®ä½ çš„é¡¹ç›® .NET ç‰ˆæœ¬è°ƒæ•´ï¼Œä¸ setup-dotnet ä¸­çš„ç‰ˆæœ¬ä¸€è‡´
            Microsoft.VisualStudio.Component.DotNetBuildTools.6.0  
            # è¿™æ˜¯å…³é”®ï¼ç¡®ä¿å®‰è£… .NET Framework 4.7.2 ç›®æ ‡åŒ…ï¼Œä»¥è§£å†³ Compiler.dll ä¾èµ–é—®é¢˜
            Microsoft.Net.Component.4.7.2.TargetingPack 
            # å¦‚æœä½ çš„WinUIé¡¹ç›®éœ€è¦UWPç‰¹æœ‰åŠŸèƒ½æˆ–æ‰“åŒ…ï¼Œå¯èƒ½è¿˜éœ€è¦æ­¤ç»„ä»¶
            Microsoft.VisualStudio.Component.UWP.BuildTools 

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ–
        # è¿è¡Œ dotnet restore æ¥ä¸‹è½½å’Œå®‰è£…é¡¹ç›®æ‰€éœ€çš„ NuGet åŒ…
        run: dotnet restore App2.sln # â­ ç¡®ä¿ 'App2.sln' æ˜¯ä½ çš„è§£å†³æ–¹æ¡ˆæ–‡ä»¶å
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX
        # ä½¿ç”¨ MSBuild å‘½ä»¤ç¼–è¯‘è§£å†³æ–¹æ¡ˆå¹¶å°†å…¶æ‰“åŒ…ä¸º MSIX
        # ç”±äº setup-msbuild Action å·²å°† MSBuild æ·»åŠ åˆ° PATHï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨
        run: |
          msbuild App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload
        shell: pwsh # ä½¿ç”¨ PowerShell æ‰§è¡Œ MSBuild å‘½ä»¤

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          # åŠ¨æ€æŸ¥æ‰¾ç”Ÿæˆçš„ .msix æ–‡ä»¶ã€‚WinUI é¡¹ç›®çš„è¾“å‡ºè·¯å¾„å¯èƒ½å› é¡¹ç›®ç»“æ„è€Œå¼‚ã€‚
          # å¸¸è§è·¯å¾„åœ¨ .\ä½ çš„é¡¹ç›®å\bin\Release\AppPackages\ æˆ– .\ä½ çš„é¡¹ç›®å\bin\Release\
          # æ­¤å¤„ä½¿ç”¨é€šç”¨æŸ¥æ‰¾ï¼Œä¼˜å…ˆåŒ¹é… AppPackages ç›®å½•æˆ– bin\Release ç›®å½•ä¸‹çš„ .msix æ–‡ä»¶
          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ msbuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        # å°†æ‰¾åˆ°çš„ MSIX æ–‡ä»¶ä½œä¸º GitHub Actions çš„â€œå·¥ä½œæµäº§ç‰©â€ä¸Šä¼ ï¼Œæ–¹ä¾¿è°ƒè¯•å’Œä¸‹è½½
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        # ä»…åœ¨é€šè¿‡æ ‡ç­¾è§¦å‘æ—¶è¿è¡Œã€‚æ­¤æ­¥éª¤å°†åœ¨ GitHub ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ Releaseã€‚
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ç”¨äºè®¤è¯çš„ä»¤ç‰Œ
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        # ä»…åœ¨é€šè¿‡æ ‡ç­¾è§¦å‘ä¸” MSIX æ–‡ä»¶æ‰¾åˆ°æ—¶è¿è¡Œã€‚æ­¤æ­¥éª¤å°† MSIX æ–‡ä»¶ä½œä¸ºé™„ä»¶ä¸Šä¼ åˆ° Releaseã€‚
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix # â­ ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´èµ„äº§æ–‡ä»¶å
          asset_content_type: application/msix
