name: æ„å»ºå¹¶å‘å¸ƒ WinUI åº”ç”¨ (PowerShell ç»„ä»¶å®‰è£…)

on:
  push:
    branches:
      - main
  create: # æ ‡ç­¾åˆ›å»ºæ—¶è§¦å‘ï¼ˆç”¨äºå‘å¸ƒ Releaseï¼‰
    tags:
      - 'v*' # åŒ¹é…ä¾‹å¦‚ v1.0.0, v1.0 ç­‰æ ‡ç­¾

jobs:
  build-and-release:
    runs-on: windows-latest # WinUI é¡¹ç›®éœ€è¦ Windows è¿è¡Œå™¨

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: âš™ï¸ è®¾ç½® .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '6.0.x' # ä¿æŒ 6.0.x

      - name: ğŸ› ï¸ å®‰è£…ç¼ºå¤±çš„ Visual Studio ç»„ä»¶
        # â­ é‡è¦ä¿®æ”¹ï¼šä½¿ç”¨ PowerShell æ˜¾å¼å®‰è£…ç»„ä»¶ã€‚
        # è¿™å°†ç¡®ä¿ç‰¹å®šçš„ SDK å’Œ WinUI æ„å»ºå·¥å…·å­˜åœ¨ã€‚
        run: |
          # å®‰è£… VSSetup PowerShell æ¨¡å—ï¼Œç”¨äºç®¡ç† Visual Studio ç»„ä»¶
          Install-Module -Name VSSetup -Force -Scope CurrentUser
          
          # è·å– Visual Studio 2022 (ç‰ˆæœ¬ 17) çš„å®‰è£…è·¯å¾„
          $vsInstallPath = (Get-VsInstallationPath -Version 17)
          if (-not $vsInstallPath) {
              Write-Error "æœªæ‰¾åˆ° Visual Studio 2022 (ç‰ˆæœ¬ 17) çš„å®‰è£…è·¯å¾„ã€‚è¯·æ£€æŸ¥ runner ç¯å¢ƒã€‚"
              exit 1
          }
          Write-Host "Visual Studio 2022 å®‰è£…è·¯å¾„: $vsInstallPath"
          
          # æ·»åŠ  WinUI/UWP æ„å»ºå·¥å…·
          Add-VsComponent -Force -ComponentID Microsoft.VisualStudio.Component.UWP.BuildTools -InstallPath $vsInstallPath
          # æ·»åŠ  Windows App SDK ç»„ä»¶
          Add-VsComponent -Force -ComponentID Microsoft.VisualStudio.Component.WindowsAppSDK -InstallPath $vsInstallPath
          # æ·»åŠ  C++ æ„å»ºå·¥å…· (v143)
          Add-VsComponent -Force -ComponentID Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -InstallPath $vsInstallPath
          # æ·»åŠ  C++ å¯å†å‘è¡Œç»„ä»¶
          Add-VsComponent -Force -ComponentID Microsoft.VisualStudio.Component.VC.Redist.14.Latest -InstallPath $vsInstallPath
          # æ·»åŠ  .NET Framework 4.7.2 ç›®æ ‡åŒ… (XAML ç¼–è¯‘å™¨éœ€è¦)
          Add-VsComponent -Force -ComponentID Microsoft.Net.Component.4.7.2.TargetingPack -InstallPath $vsInstallPath
          
          # â­ å…³é”®ï¼šå®‰è£…é¡¹ç›®ä¾èµ–çš„ç‰¹å®š Windows SDK 10.0.26100.0
          # ç»„ä»¶ ID é€šå¸¸æ˜¯ 'Microsoft.VisualStudio.Component.Windows10SDK.æ„å»ºå·'
          Add-VsComponent -Force -ComponentID Microsoft.VisualStudio.Component.Windows10SDK.26100 -InstallPath $vsInstallPath
          
          Write-Host "âœ… Visual Studio ç»„ä»¶å®‰è£…å®Œæˆã€‚"
        shell: pwsh

      - name: ğŸ› ï¸ è®¾ç½® MSBuild (åœ¨ç»„ä»¶å®‰è£…åï¼Œç¡®ä¿å…¶è·¯å¾„æ­£ç¡®)
        uses: microsoft/setup-msbuild@v2 

      - name: ğŸ§¹ æ¸…ç† NuGet å…¨å±€ç¼“å­˜ (å¯é€‰ï¼Œä½†æœ‰åŠ©äºç¡®ä¿å…¨æ–°ä¸‹è½½)
        run: dotnet nuget locals all --clear
        shell: pwsh

      - name: ğŸ“¦ æ¢å¤é¡¹ç›®ä¾èµ– (ä½¿ç”¨ MSBuild)
        run: msbuild App2.sln /t:restore
        shell: pwsh

      - name: ğŸš€ ç¼–è¯‘å¹¶æ‰“åŒ… WinUI åº”ç”¨ä¸º MSIX
        run: |
          msbuild App2.sln /p:Configuration=Release /p:Platform="x64" /p:AppxBundle=Always /p:AppxBundlePlatforms="x64" /p:UapAppxPackageBuildMode=StoreUpload
        shell: pwsh 

      - name: ğŸ” æŸ¥æ‰¾ MSIX å®‰è£…åŒ…
        id: find_msix
        run: |
          $msixPath = Get-ChildItem -Path ".\**\*.msix" -Recurse | Where-Object { $_.FullName -like "*AppPackages*" -or $_.DirectoryName -like "*bin\Release*" } | Select-Object -ExpandProperty FullName | Select-Object -First 1
          if ($msixPath) {
              echo "msix_path=$msixPath" >> $env:GITHUB_OUTPUT
              Write-Host "âœ… å·²æ‰¾åˆ° MSIX å®‰è£…åŒ…: $msixPath"
          } else {
              Write-Error "âŒ æœªæ‰¾åˆ° MSIX å®‰è£…åŒ…ã€‚è¯·æ£€æŸ¥ä½ çš„é¡¹ç›®æ„å»ºè¾“å‡ºè·¯å¾„å’Œ MSBuild å‚æ•°ã€‚"
              exit 1
          }
        shell: pwsh

      - name: â¬†ï¸ ä¸Šä¼  MSIX ä½œä¸ºå·¥ä½œæµäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: SCE-NEXT-MSIX-Package
          path: ${{ steps.find_msix.outputs.msix_path }}

      - name: âœ¨ åˆ›å»º GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false

      - name: ğŸ“¤ ä¸Šä¼  MSIX åˆ° Release èµ„äº§
        if: startsWith(github.ref, 'refs/tags/') && steps.find_msix.outputs.msix_path
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.find_msix.outputs.msix_path }}
          asset_name: SCE-NEXT.msix
          asset_content_type: application/msix
